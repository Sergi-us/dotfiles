#!/bin/sh
# Postrun script for hellwal
## 2025-11-29 SARBS

waldir="${XDG_CACHE_HOME:-$HOME/.cache}/wal"

# Reload Xresources
xrdb -merge "$waldir/colors.Xresources" 2>/dev/null

# Symlink dunstrc, zathurarc, kitty und alacritty colors zu config dirs
dunstconf="${XDG_CONFIG_HOME:-$HOME/.config}/dunst/dunstrc"
zathuraconf="${XDG_CONFIG_HOME:-$HOME/.config}/zathura/zathurarc"
kittyconf="${XDG_CONFIG_HOME:-$HOME/.config}/kitty/colors-kitty.conf"
alacrittyconf="${XDG_CONFIG_HOME:-$HOME/.config}/alacritty/colors-alacritty.toml"

mkdir -p "${dunstconf%/*}" "${zathuraconf%/*}" "${kittyconf%/*}" "${alacrittyconf%/*}"
ln -sf "$waldir/dunstrc" "$dunstconf"
ln -sf "$waldir/zathurarc" "$zathuraconf"
ln -sf "$waldir/colors-kitty.conf" "$kittyconf"
ln -sf "$waldir/colors-alacritty.toml" "$alacrittyconf"

# Copy tut theme to config
tutdir="${XDG_CONFIG_HOME:-$HOME/.config}/tut/themes"
mkdir -p "$tutdir"
cp "$waldir/tut.toml" "$tutdir/pywal-generated.toml"

# Fix terminal sequences (additional color indices)
fix_sequences() {
    e=$'\e'
    sequences=$(cat)
    foreground_color="$(echo -e "${sequences}\c" | grep --color=never -Eo "${e}]10[^${e}\\\\]*?${e}\\\\" | grep --color=never -Eo "#[0-9A-Fa-f]{6}")"
    background_color="$(echo -e "${sequences}\c" | grep --color=never -Eo "${e}]11[^${e}\\\\]*?${e}\\\\" | grep --color=never -Eo "#[0-9A-Fa-f]{6}")"
    cursor_color="$(echo -e "${sequences}\c" | grep --color=never -Eo "${e}]12[^${e}\\\\]*?${e}\\\\" | grep --color=never -Eo "#[0-9A-Fa-f]{6}")"

    for term in /dev/pts/{0..9}*; do
        echo -e "\e]4;256;${cursor_color}\a\c" > "${term}" 2>/dev/null
        echo -e "\e]4;258;${background_color}\a\c" > "${term}" 2>/dev/null
        echo -e "\e]4;259;${foreground_color}\a\c" > "${term}" 2>/dev/null
    done
}

fix_sequences <"$waldir/sequences"

# Restart dunst - sicherstellen dass alle Instanzen beendet werden
# Erst sanft versuchen
pkill -TERM dunst
# Kurz warten bis Prozess beendet ist
sleep 0.2
# Falls noch läuft, härter zuschlagen
pkill -KILL dunst 2>/dev/null
# Nochmal kurz warten
sleep 0.1
# Neu starten
setsid -f dunst >/dev/null 2>&1

# Reload kitty colors in allen laufenden Instanzen
if [ -x "$(command -v kitty)" ]; then
    kitty @ --to unix:/tmp/kitty set-colors --all --configured "$waldir/colors-kitty.conf" 2>/dev/null || true
fi
