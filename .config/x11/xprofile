#!/bin/sh
## 2026-02-16   SARBS
# X11-spezifische Umgebungsvariablen und Konfigurationen.
# Wirkt nur in grafischen X11-Sitzungen.
# Spezifisch für grafische Programme unter X11.

# === DPI und Skalierfaktor Konfiguration ===
# Zentrale Logik in set-dpi (siehe ~/.local/bin/set-dpi -h)
# Default-Wert und DISPLAY_ADJUST werden in set-dpi verwaltet.
# Justierung aendern: set-dpi -j -15 (persistent, sofort wirksam)
# Stellschrauben (Umgebungsvariablen):
#   FORCE_DPI=192      Überspringt Auto-Erkennung komplett
#   FORCE_SCALE=1.25   Überspringt Scale-Ableitung
#
# set-dpi berechnet DPI, setzt State-Dateien, xrandr, GTK/fontconfig
# Wird gesourced (.) damit MASTER_DPI, SCALE_FACTOR, XCURSOR_SIZE
# als Umgebungsvariablen in dieser Session verfügbar bleiben.
if [ -x "$(command -v set-dpi)" ]; then
	. set-dpi -s
else
	# Fallback falls set-dpi nicht verfügbar
	xrandr --dpi 96
	MASTER_DPI=96
	SCALE_FACTOR=1
	XCURSOR_SIZE=24
	export XCURSOR_SIZE
fi
# TODO Xft.dpi wird automatisch gesetzt - alte X11-Apps lesen das (muss noch eingerichtet werden)

# === Themes und GUI ===
export GTK_THEME=Breeze-Dark                                    # Überschreibt gsettings - sinnvoll für Window Manager ohne GNOME
export GTK3_RC_FILES="$XDG_CONFIG_HOME/gtk-3.0/settings.ini"    # GTK3 liest Einstellungen von hier
# GTK4 nutzt keine RC_FILES mehr - nur noch gsettings!
# export GTK2_RC_FILES="$XDG_CONFIG_HOME/gtk-2.0/gtkrc-2.0"     # GTK2 ist obsolet - nur behalten falls alte Apps (GIMP 2.8, etc.)

# === GTK Skalierung ===
export GDK_DPI_SCALE=$SCALE_FACTOR
# GDK_SCALE nicht setzen - würde Integer-Only Skalierung erzwingen

# DPI-Only: Alle GTK-Skalierung deaktivieren
# unset GDK_DPI_SCALE                                     # dpi-only lösung (Würde DPI-Wert multiplizieren - wollen wir nicht!)
# unset GDK_SCALE                                         # Integer-Skalierung - nicht nötig bei DPI-Only

# Qt Settings - nur eine Platform Theme Variable pro Qt-Version!
export QT_QPA_PLATFORMTHEME=qt6ct                       # Qt6 Theme-Integration
export QT5_QPA_PLATFORMTHEME=qt5ct                      # Qt5 Theme-Integration (parallel installierbar)
export QT_FONT_DPI=$MASTER_DPI                          # Explizit setzen - manche Qt-Apps ignorieren xrandr
export QT_SCALE_FACTOR=$SCALE_FACTOR                    # Zusätzliche Qt-Skalierung
# export QT_SCALE_FACTOR=$SCALE_FACTOR                    # Zusätzliche Qt-Skalierung
# unset QT_SCALE_FACTOR                                   # DPI-Only - Keine zusätzliche Skalierung!
export QT_SCALE_FACTOR_ROUNDING_POLICY=PassThrough      # Bestimmt, wie nicht-ganzzahlige Skalierungsfaktoren behandelt werden
# PassThrough ist nur relevant wenn QT_SCALE_FACTOR gesetzt wäre - schadet aber nicht


# unset ELM_SCALE                                         # Enlightenment/EFL - nutzt jetzt System-DPI

# === Optionale Features (aktuell deaktiviert) ===
# export QT_AUTO_SCREEN_SCALE_FACTOR=1    # VORSICHT: Würde Qt eigene Skalierung berechnen lassen!
                                           # Könnte DPI-Only Ansatz stören
# export QT_ENABLE_HIGHDPI_SCALING=1      # Deprecated - Qt macht das automatisch

# HiDPI Settings
# export QT_ENABLE_HIGHDPI_SCALING=1                    # Option ist - Qt6: veraltet, Qt5: default seit 5.14
# export QT_AUTO_SCREEN_SCALE_FACTOR=1                  # Überschreibt QT_SCALE_FACTOR (kommt vieleicht in frage als alternative zu chromium wrapper skripten )

# === Bildschirm (kann mit MOD+Löschen beinflusst werden) ===
xset s off          # Bildschirmschoner deaktivieren
xset -dpms          # Energiesparmodus deaktivieren
xset s noblank      # Kein automatisches Bildschirm-Blanking
setbg &             # Setzt den Hintergrund mit dem `setbg` Skript

# === Verhalten von Eingabegeräten ===
xbanish &           # Mauszeiger beim Tippen ausblenden
# xinput set-prop 10 "libinput Natural Scrolling Enabled" 1     # Aktiviert Natural Scrolling (Mac-like)


## Lädt Xresources Farben/Einstellungen beim Start
## TODO Trennen von Skalierung und Farben
## wenn xrdb aktiviert, dann "~/.config/x11/xresources" beachten
## xrdb ${XDG_CONFIG_HOME:-$HOME/.config}/x11/xresources & xrdbpid=$!

# === pamgnupg ===
export GPG_TTY=$(tty)
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpg-connect-agent updatestartuptty /bye >/dev/null

# === Liste der automatisch zu startenden Programme ===
autostart="mpd dunst unclutter pipewire remapd picom -d"

for program in $autostart; do
	pidof -sx "$program" || "$program" &
done >/dev/null 2>&1

# Stellt sicher, dass xrdb fertig ist, bevor DWM gestartet wird
[ -n "$xrdbpid" ] && wait "$xrdbpid"
