#!/bin/bash
## 2025-07-26   SARBS
# convert-video - Video-Konvertierung mit FLAC-Audio f√ºr DaVinci Resolve Linux
# Installiere in ~/.local/bin/convert-video

set -e

# Eingabedatei pr√ºfen
if [ -z "$1" ]; then
    echo "Verwendung: $(basename "$0") <video-datei> [--pcm f√ºr unkomprimiertes Audio]"
    exit 1
fi

input="$1"
use_pcm=false

# Parameter pr√ºfen
if [ "$2" = "--pcm" ]; then
    use_pcm=true
fi

dir_name=$(dirname "$input")
base_name=$(basename "$input")
filename="${base_name%.*}"

# Ausgabeformat - MP4 Container (FLAC in MOV funktioniert nicht)
output="${dir_name}/${filename}_video.mp4"

echo "Konvertiere: $input"

# Audio-Codec ausw√§hlen
if [ "$use_pcm" = true ]; then
    audio_codec="-c:a pcm_s16le -ar 48000"
    echo "Audio: PCM (unkomprimiert, maximale Kompatibilit√§t)"
else
    # FLAC: Verlustfrei komprimiert, von DaVinci Linux unterst√ºtzt
    audio_codec="-c:a flac -ar 48000 -sample_fmt s16 -compression_level 8"
    echo "Audio: FLAC (verlustfrei komprimiert, ~50% kleiner als PCM)"
fi

# Hardware-Encoder Erkennung und Konvertierung
converted=false

# 1. Versuch: NVIDIA (RTX 5000 auf Dell Precision)
if command -v nvidia-smi &> /dev/null && nvidia-smi &> /dev/null; then
    echo "üéÆ NVIDIA GPU erkannt - verwende NVENC Hardware-Encoding..."
    if ffmpeg -hwaccel cuda -i "$input" \
           -c:v h264_nvenc -preset p4 -b:v 10M -maxrate 15M -bufsize 20M \
           $audio_codec \
           -strict experimental \
           -f mp4 \
           -movflags +faststart \
           "$output" 2>/dev/null; then
        converted=true
        echo "‚úÖ NVIDIA Hardware-Encoding erfolgreich"
    else
        echo "‚ö†Ô∏è  NVIDIA Encoding fehlgeschlagen, versuche Intel..."
    fi
fi

# 2. Versuch: Intel VAAPI (UHD 630 auf T480)
if [ "$converted" = false ] && [ -e /dev/dri/renderD128 ] && command -v vainfo &> /dev/null; then
    echo "üíª Intel GPU erkannt - verwende VAAPI Hardware-Encoding..."
    if ffmpeg -hwaccel vaapi -hwaccel_device /dev/dri/renderD128 -hwaccel_output_format vaapi -i "$input" \
           -vf 'scale_vaapi=format=nv12' \
           -c:v h264_vaapi -qp 23 \
           $audio_codec \
           -strict experimental \
           -f mp4 \
           -movflags +faststart \
           "$output" 2>/dev/null; then
        converted=true
        echo "‚úÖ Intel VAAPI Hardware-Encoding erfolgreich"
    else
        echo "‚ö†Ô∏è  Intel Encoding fehlgeschlagen, verwende CPU..."
    fi
fi

# 3. Fallback: CPU (funktioniert immer)
if [ "$converted" = false ]; then
    echo "üñ•Ô∏è  Verwende CPU-Encoding (libx264)..."
    ffmpeg -i "$input" \
           -c:v libx264 -preset medium -crf 18 \
           $audio_codec \
           -strict experimental \
           -f mp4 \
           -movflags +faststart \
           "$output"
    echo "‚úÖ CPU-Encoding erfolgreich"
fi

# Gr√∂√üenvergleich
original_size=$(du -h "$input" | cut -f1)
new_size=$(du -h "$output" | cut -f1)
echo ""
echo "Original: $original_size"
echo "Konvertiert: $new_size"
echo "Fertig: $output"

# Hilfreiche Infos
if [ "$use_pcm" = false ]; then
    echo ""
    echo "Hinweis: Falls DaVinci Probleme mit FLAC hat, verwende:"
    echo "  $(basename "$0") \"$input\" --pcm"
fi
