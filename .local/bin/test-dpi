#!/bin/sh
## 2025-12-11   SARBS
# X11 Test-Skript fÃ¼r DPI/SCALE-Erkennung ohne Neuen Login
# Berechnet DPI und SCALE_FACTOR basierend auf aktueller Display-Konfiguration

echo "=== DPI/SCALE Test-Tool ==="
echo ""

# Zeige aktuelle Display-Konfiguration
echo "ðŸ“º Aktive Displays:"
xrandr | grep " connected" | grep -v "disconnected"
echo ""

# Source die Berechnungsfunktionen aus .xprofile
# Wir definieren sie hier neu, um keine Programme zu starten
calculate_auto_dpi() {
	default_dpi=96
	primary_info=$(xrandr 2>/dev/null | grep " connected primary" | grep -E '[0-9]+x[0-9]+\+[0-9]+')
	[ -z "$primary_info" ] && primary_info=$(xrandr 2>/dev/null | grep " connected" | grep -E '[0-9]+x[0-9]+\+[0-9]+' | head -n 1)
	[ -z "$primary_info" ] && primary_info=$(xrandr 2>/dev/null | grep " connected primary")
	[ -z "$primary_info" ] && primary_info=$(xrandr 2>/dev/null | grep " connected" | head -n 1)
	[ -z "$primary_info" ] && { echo "$default_dpi"; return; }

	resolution=$(echo "$primary_info" | grep -oE '[0-9]+x[0-9]+\+[0-9]+\+[0-9]+' | head -n 1 | cut -d'+' -f1)
	if [ -z "$resolution" ]; then
		display_name=$(echo "$primary_info" | awk '{print $1}')
		resolution=$(xrandr 2>/dev/null | grep -A 1 "^$display_name " | tail -n 1 | awk '{print $1}')
	fi

	px_w=$(echo "$resolution" | cut -d'x' -f1)
	physical=$(echo "$primary_info" | grep -oE '[0-9]+mm x [0-9]+mm')
	mm_w=$(echo "$physical" | cut -d'm' -f1)

	[ -z "$px_w" ] || [ -z "$mm_w" ] || [ "$mm_w" -eq 0 ] 2>/dev/null && { echo "$default_dpi"; return; }

	# Berechne DPI - versuche erst bc, dann POSIX-Arithmetik
	if command -v bc >/dev/null 2>&1; then
		calculated_dpi=$(echo "scale=0; ($px_w * 25.4) / $mm_w" | bc 2>/dev/null)
	else
		# Fallback: POSIX Shell-Arithmetik (nur Ganzzahlen)
		# DPI = (px_w * 25.4) / mm_w = (px_w * 254) / (mm_w * 10)
		calculated_dpi=$(( (px_w * 254) / (mm_w * 10) ))
	fi
	[ -z "$calculated_dpi" ] && { echo "$default_dpi"; return; }

	if [ "$calculated_dpi" -lt 108 ]; then echo "96"
	elif [ "$calculated_dpi" -lt 132 ]; then echo "120"
	elif [ "$calculated_dpi" -lt 156 ]; then echo "144"
	elif [ "$calculated_dpi" -lt 180 ]; then echo "168"
	elif [ "$calculated_dpi" -lt 216 ]; then echo "192"
	elif [ "$calculated_dpi" -lt 264 ]; then echo "240"
	else echo "288"
	fi
}

calculate_scale_factor() {
	dpi="$1"
	if [ "$dpi" -le 144 ]; then echo "1"
	elif [ "$dpi" -le 192 ]; then echo "1.25"
	elif [ "$dpi" -le 240 ]; then echo "1.5"
	else echo "2"
	fi
}

# Berechne neue Werte
MASTER_DPI=$(calculate_auto_dpi)
SCALE_FACTOR=$(calculate_scale_factor "$MASTER_DPI")

# Zeige Berechnungsdetails
primary_display=$(xrandr | grep " connected primary" | awk '{print $1}')
[ -z "$primary_display" ] && primary_display=$(xrandr | grep " connected" | head -n 1 | awk '{print $1}')

display_info=$(xrandr | grep "^$primary_display connected")
resolution=$(echo "$display_info" | grep -oE '[0-9]+x[0-9]+\+[0-9]+\+[0-9]+' | head -n 1 | cut -d'+' -f1)
physical=$(echo "$display_info" | grep -oE '[0-9]+mm x [0-9]+mm')

echo "ðŸ–¥ï¸  Primary Display: $primary_display"
echo "   AuflÃ¶sung: $resolution"
echo "   Physisch: $physical"

# Berechne tatsÃ¤chliche DPI
if [ -n "$resolution" ] && [ -n "$physical" ]; then
	px_w=$(echo "$resolution" | cut -d'x' -f1)
	mm_w=$(echo "$physical" | cut -d'm' -f1)
	if command -v bc >/dev/null 2>&1; then
		real_dpi=$(echo "scale=1; ($px_w * 25.4) / $mm_w" | bc 2>/dev/null)
	else
		# Fallback: POSIX Shell-Arithmetik mit einer Nachkommastelle
		real_dpi_int=$(( (px_w * 254) / (mm_w * 10) ))
		real_dpi_dec=$(( ((px_w * 254) % (mm_w * 10)) * 10 / (mm_w * 10) ))
		real_dpi="${real_dpi_int}.${real_dpi_dec}"
	fi
	echo "   TatsÃ¤chliche DPI: $real_dpi"
fi

echo ""
echo "ðŸ“Š Berechnete Werte:"
echo "   MASTER_DPI = $MASTER_DPI"
echo "   SCALE_FACTOR = $SCALE_FACTOR"

# Vergleich mit aktuellen State-Dateien
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/xsession"
if [ -f "$state_dir/dpi" ] && [ -f "$state_dir/scale" ]; then
	old_dpi=$(cat "$state_dir/dpi")
	old_scale=$(cat "$state_dir/scale")
	echo ""
	echo "ðŸ“ Aktuelle State-Dateien:"
	echo "   DPI: $old_dpi â†’ $MASTER_DPI"
	echo "   SCALE: $old_scale â†’ $SCALE_FACTOR"

	if [ "$old_dpi" != "$MASTER_DPI" ] || [ "$old_scale" != "$SCALE_FACTOR" ]; then
		echo ""
		echo "âš ï¸  Werte haben sich geÃ¤ndert!"
		echo ""
		read -p "State-Dateien aktualisieren? (j/N) " answer
		case "$answer" in
			j|J|y|Y)
				echo "$SCALE_FACTOR" > "$state_dir/scale"
				echo "$MASTER_DPI" > "$state_dir/dpi"
				xrandr --dpi $MASTER_DPI
				export MASTER_DPI
				export SCALE_FACTOR
				export GDK_DPI_SCALE=$SCALE_FACTOR
				export QT_FONT_DPI=$MASTER_DPI
				export QT_SCALE_FACTOR=$SCALE_FACTOR
				echo "âœ… State-Dateien aktualisiert!"
				echo "âœ… xrandr --dpi $MASTER_DPI ausgefÃ¼hrt"
				echo "âœ… Umgebungsvariablen gesetzt (fÃ¼r neue Apps)"
				echo ""
				echo "ðŸ’¡ Starte Apps neu, um neue Skalierung zu sehen:"
				echo "   - Browser: chromium, brave, firefox, etc."
				echo "   - Terminals bekommen neue DPI automatisch"
				;;
			*)
				echo "Abgebrochen. Keine Ã„nderungen."
				;;
		esac
	else
		echo ""
		echo "âœ… Werte sind bereits aktuell, keine Ã„nderungen nÃ¶tig."
	fi
else
	echo ""
	echo "State-Dateien existieren nicht, erstelle sie..."
	mkdir -p "$state_dir"
	echo "$SCALE_FACTOR" > "$state_dir/scale"
	echo "$MASTER_DPI" > "$state_dir/dpi"
	xrandr --dpi $MASTER_DPI
	echo "âœ… State-Dateien erstellt!"
fi

echo ""
echo "=== Fertig ==="
