#!/bin/sh
## 2025-01-09 SARBS
# TODO Testversion des unmount Skript's welches enutzte GerÃ¤te erkennen und deaktivieren soll
# Eingabeaufforderungen und entschlÃ¼sselt auch LUKS-Laufwerke, die ausgehÃ¤ngt werden.
# TODO Sicherstellen dass alle SchreibvorgÃ¤nge abgeschlossen sind bevor etwas ausgeworfen wird... Die Aktuelle Logig ist noch in der Testphase...

set -e

# ÃœberprÃ¼fen und Beenden von Prozessen, die das Zielverzeichnis verwenden
kill_processes_using_directory() {
    directory=$1
    process_list=$(lsof +D "$directory" | awk 'NR>1 {print $2}')

    if [ -n "$process_list" ]; then
        notify-send "Folgende Prozesse verwenden $directory und werden beendet:"
        notify-send "$process_list"
        notify-send "$process_list" | xargs sudo kill -9
        notify-send "Prozesse beendet."
    else
        notify-send "Keine Prozesse verwenden $directory."
    fi
}

mounteddroids="$(grep simple-mtpfs /etc/mtab | awk '{print "ğŸ“±" $2}')"
lsblkoutput="$(lsblk -nrpo "name,type,size,mountpoint")"
mounteddrives="$(echo "$lsblkoutput" | awk '($2=="part"||$2="crypt")&&$4!~/\/boot|\/home$|SWAP/&&length($4)>1{printf "ğŸ’¾%s (%s)\n",$4,$3}')"

allunmountable="$(echo "$mounteddroids
$mounteddrives" | sed "/^$/d;s/ *$//")"
test -n "$allunmountable"

chosen="$(echo "$allunmountable" | dmenu -i -p "Welches Laufwerk aushÃ¤ngen?")"
chosen="${chosen%% *}"
test -n "$chosen"

# Verzeichnispfad extrahieren
mountpoint="/${chosen#*/}"

# Prozesse beenden, die das Zielverzeichnis verwenden
kill_processes_using_directory "$mountpoint"

# Laufwerk aushÃ¤ngen
sudo -A umount -l "$mountpoint"
notify-send "GerÃ¤t ausgehÃ¤ngt." "$chosen wurde ausgehÃ¤ngt."

# SchlieÃŸt das ausgewÃ¤hlte Laufwerk, wenn es entschlÃ¼sselt ist.
cryptid="$(echo "$lsblkoutput" | grep "/${chosen#*/}$")"
cryptid="${cryptid%% *}"
if [ -b /dev/mapper/"${cryptid##*/}" ]; then
    sudo -A cryptsetup close "$cryptid"
    notify-send "ğŸ”’GerÃ¤teverschlÃ¼sselung geschlossen." "Laufwerk ist jetzt wieder sicher verschlossen."
fi
