#!/bin/sh
## 2025-03-27 SARBS

# TODO Standard widergabeger√§t wird noch nicht angezeigt

# Konfiguration
# Auf "true" setzen, um die Prozentanzeige auszublenden
HIDE_PERCENTAGE="true"

# Funktion f√ºr Benachrichtigung mit Pegelanzeige
# Bereiche: 0-100 = low, 101-200 = normal (anpassbar im Code)
show_volume_notification() {
    local new_vol=$1
    local urgency="normal"

    # Bereich 0-100: low urgency
    # Bereich 101-200: normal urgency
    if [ "$new_vol" -le 100 ]; then
        urgency="low"
    else
        urgency="normal"
    fi

    dunstify -u "$urgency" -h "int:value:$new_vol" --replace=69420 "Lautst√§rke" "$new_vol%"
}

# Funktion zum Holen und Formatieren der aktuellen Volume-Info
# Setzt globale Variablen: vol, muted
get_volume_info() {
    _vol_info=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
    vol=$(echo "$_vol_info" | awk '{print $2}')
    muted=$(echo "$_vol_info" | grep -q MUTED && echo "yes" || echo "no")
    vol=$(awk -v vol="$vol" 'BEGIN{printf "%.0f\n", vol * 100}')
}

# Funktion zur Icon-Bestimmung
# Setzt globale Variable: icon
get_icon() {
    if [ "$muted" = "yes" ]; then
        icon="Û∞ñÅ"
    elif [ "$vol" -ge 70 ]; then
        icon="Û∞ïæ"
    elif [ "$vol" -ge 30 ]; then
        icon="Û∞ñÄ"
    elif [ "$vol" -ge 1 ]; then
        icon="Û∞ïø"
    else
        icon="Û∞ùü"
    fi
}

# Pr√ºfe ob das Skript durch Signal 55 (von DWM) aufgerufen wurde
if [ "$1" = "55" ]; then
    # Lautst√§rke wurde √ºber DWM-Tastaturk√ºrzel ge√§ndert
    get_volume_info
    show_volume_notification "$vol"
    exit 0
fi

# Handle button clicks
case $BLOCK_BUTTON in
    1)
        wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
        # Nach Toggle: neuen Status holen und anzeigen
        get_volume_info
        get_icon
        if [ "$muted" = "yes" ]; then
            dunstify -u "normal" --replace=69420 " Stummgeschaltet"
        else
            show_volume_notification "$vol"
        fi
        # Icon sofort ausgeben, dann Signal senden
        if [ "$HIDE_PERCENTAGE" = "true" ]; then
            echo "$icon"
        else
            echo "$icon $vol%"
        fi
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        exit 0
        ;;
    2)
        setsid -w -f "$TERMINAL" -e pulsemixer
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        exit 0
        ;;
    3)
        # Aktuelle Werte f√ºr Info-Anzeige holen
        get_volume_info
        get_icon
        current_device=$(pactl list sinks | awk -v sink="$(pactl get-default-sink)" '$0 ~ "Name: "sink{flag=1} flag && /Description:/{sub(/.*Description: /, ""); print; exit}')
        notify-send "Lautst√§rke Modul" "\- Zeigt Lauts√§rke üîä $vol%,
- Aktives Ger√§t: $current_device
- L Û∞çΩ Stumm
- M Û∞çΩ Pulsmixer
- Û±ïí Lautst√§rke √§ndern
"
        # Icon sofort ausgeben vor exit
        if [ "$HIDE_PERCENTAGE" = "true" ]; then
            echo "$icon"
        else
            echo "$icon $vol%"
        fi
        exit 0
        ;;
    4)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+
        # Nach √Ñnderung: neuen Wert holen und anzeigen
        get_volume_info
        get_icon
        show_volume_notification "$vol"
        # Icon sofort ausgeben, dann Signal senden
        if [ "$HIDE_PERCENTAGE" = "true" ]; then
            echo "$icon"
        else
            echo "$icon $vol%"
        fi
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        exit 0
        ;;
    5)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
        # Nach √Ñnderung: neuen Wert holen und anzeigen
        get_volume_info
        get_icon
        show_volume_notification "$vol"
        # Icon sofort ausgeben, dann Signal senden
        if [ "$HIDE_PERCENTAGE" = "true" ]; then
            echo "$icon"
        else
            echo "$icon $vol%"
        fi
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        exit 0
        ;;
    6)
        setsid -f "$TERMINAL" -e "$EDITOR" "$0"
        exit 0
        ;;
esac

# Normale Anzeige (f√ºr Statusbar-Updates)
get_volume_info
get_icon

if [ "$HIDE_PERCENTAGE" = "true" ]; then
    echo "$icon"
else
    echo "$icon $vol%"
fi
