#!/bin/sh
## 2025-03-27 SARBS

# TODO Standard widergabeger√§t wird noc nicht angezeigt

# Konfiguration
# Auf "true" setzen, um die Prozentanzeige auszublenden
HIDE_PERCENTAGE="true"

# Get the current volume, mute status and device name
vol_info=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
vol=$(echo "$vol_info" | awk '{print $2}')
muted=$(echo "$vol_info" | grep -q MUTED && echo "yes" || echo "no")

# Get current audio device name
current_device=$(pactl get-default-sink | xargs pactl list sinks | grep -A 2 "Name: " | grep "Description" | sed 's/.*Description: //')

# Convert volume to percentage
vol=$(awk -v vol="$vol" 'BEGIN{printf "%.0f\n", vol * 100}')

# Determine the icon
if [ "$muted" = "yes" ]; then
    icon="Û∞ñÅ"
elif [ "$vol" -ge 70 ]; then
    icon="Û∞ïæ"
elif [ "$vol" -ge 30 ]; then
    icon="Û∞ñÄ"
elif [ "$vol" -ge 1 ]; then
    icon="Û∞ïø"
else
    icon="Û∞ùü"
fi

# Funktion f√ºr Benachrichtigung mit Pegelanzeige
show_volume_notification() {
    local new_vol=$1
    local urgency="normal"

    if [ "$new_vol" -gt 100 ]; then
        urgency="critical"
    elif [ "$new_vol" -eq 0 ]; then
        urgency="low"
    fi

    dunstify -u "$urgency" -h "int:value:$new_vol" --replace=69420 "Lautst√§rke" "$new_vol%"
}

# Pr√ºfe ob das Skript durch Signal 55 (von DWM) aufgerufen wurde
if [ "$1" = "55" ]; then
    # Lautst√§rke wurde √ºber DWM-Tastaturk√ºrzel ge√§ndert
    new_vol_info=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
    new_vol_decimal=$(echo "$new_vol_info" | awk '{print $2}')
    new_vol=$(awk -v vol="$new_vol_decimal" 'BEGIN{printf "%.0f\n", vol * 100}')
    show_volume_notification "$new_vol"
    exit 0
fi

case $BLOCK_BUTTON in
    1)
        wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
        # Neuen Status holen
        new_vol_info=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
        new_muted=$(echo "$new_vol_info" | grep -q MUTED && echo "yes" || echo "no")
        if [ "$new_muted" = "yes" ]; then
            dunstify -u "low" --replace=69420 "Lautst√§rke" "Stummgeschaltet"
        else
            new_vol_decimal=$(echo "$new_vol_info" | awk '{print $2}')
            new_vol=$(awk -v vol="$new_vol_decimal" 'BEGIN{printf "%.0f\n", vol * 100}')
            show_volume_notification "$new_vol"
        fi
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        ;;
    2) setsid -w -f "$TERMINAL" -e pulsemixer; pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}" ;;
    3) notify-send "Lautst√§rke Modul" "\- Zeigt Lauts√§rke üîä $vol%,
- Aktives Ger√§t: $current_device
- L Û∞çΩ Stumm
- M Û∞çΩ Pulsmixer
- Û±ïí Lautst√§rke √§ndern
" ;;
    4)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+
        # Neue Lautst√§rke holen f√ºr Benachrichtigung
        new_vol_info=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
        new_vol_decimal=$(echo "$new_vol_info" | awk '{print $2}')
        new_vol=$(awk -v vol="$new_vol_decimal" 'BEGIN{printf "%.0f\n", vol * 100}')
        show_volume_notification "$new_vol"
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        ;;
    5)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
        # Neue Lautst√§rke holen f√ºr Benachrichtigung
        new_vol_info=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
        new_vol_decimal=$(echo "$new_vol_info" | awk '{print $2}')
        new_vol=$(awk -v vol="$new_vol_decimal" 'BEGIN{printf "%.0f\n", vol * 100}')
        show_volume_notification "$new_vol"
        pkill -RTMIN+21 "${STATUSBAR:-dwmblocks}"
        ;;
    6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

if [ "$HIDE_PERCENTAGE" = "true" ]; then
    echo "[$icon]"
else
    echo "[$icon $vol%]"
fi
