#!/bin/sh
## 2025-01-09 SARBS

# Ermittelt Ihre √∂ffentliche IP-Adresse (IPv4 oder IPv6), pr√ºft, in welchem Land Sie sich befinden,
# und zeigt diese Information in der Statusleiste an

ifinstalled "geoip"

getipinfo() {
	# IP-Adresse abrufen (unterst√ºtzt sowohl IPv4 als auch IPv6)
	ip=$(curl -s ifconfig.me)

	# Pr√ºfen, ob es sich um eine IPv6-Adresse handelt
	if echo "$ip" | grep -q ':'; then
		# IPv6
		addr=$(geoiplookup6 -f /usr/share/GeoIP/GeoIPv6.dat "$ip" 2>/dev/null)
	else
		# IPv4
		addr=$(geoiplookup -f /usr/share/GeoIP/GeoIP.dat "$ip" 2>/dev/null)
	fi

	# Extrahiere L√§ndercode (z.B. "DE") und L√§ndername
	country_code="${addr#*: }"
	country_code="${country_code%%,*}"
	country_name="${addr##*, }"

	# Gebe alle Infos zur√ºck
	printf "%s|%s|%s" "$ip" "$country_code" "$country_name"
}

case $BLOCK_BUTTON in
	1) notify-send "üåç IP-Standort" "$(getipinfo | awk -F'|' '{print "IP: "$1"\nLand: "$3" ("$2")"}')" ;;
	3) info=$(getipinfo)
	   ip=$(echo "$info" | cut -d'|' -f1)
	   code=$(echo "$info" | cut -d'|' -f2)
	   name=$(echo "$info" | cut -d'|' -f3)
	   notify-send "üåç IP-Standort - Vollst√§ndige Informationen" "IP-Adresse: $ip\n\nL√§ndercode: $code\nLand: $name\n\nTyp: $(echo "$ip" | grep -q ':' && echo "IPv6" || echo "IPv4")" ;;
	6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

# Statusleisten-Ausgabe: Zeige nur L√§ndercode
info=$(getipinfo)
country_code=$(echo "$info" | cut -d'|' -f2)
printf "%s\\n" "[$country_code]"
