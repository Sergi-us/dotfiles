#!/bin/sh
## 2025-01-18 SARBS
## Ermittelt Ã¶ffentliche IP und Standort - NUR bei Klicks (Signal 0)
## Zeigt VPN-Status in Statusleiste, fÃ¼hrt Abfragen nur bei Interaktion aus

# Cache-Datei fÃ¼r IP-Informationen
CACHE_DIR="${XDG_DATA_HOME:-$HOME/.local/share}"
CACHE_FILE="$CACHE_DIR/iplocate"

# PrÃ¼fe ob VPN aktiv ist (lokal, ohne externe Abfrage)
check_vpn() {
	for iface in /sys/class/net/*; do
		[ ! -e "$iface" ] && continue
		iface_name="${iface##*/}"
		case "$iface_name" in
			tun*|tap*|wg*|ppp*|vpn*)
				state=$(cat "$iface/operstate" 2>/dev/null)
				if [ "$state" = "up" ] || [ "$state" = "unknown" ]; then
					echo "$iface_name"
					return 0
				fi
				;;
		esac
	done
	return 1
}

# Lade gespeicherte Informationen aus Cache
load_cached_info() {
	if [ -f "$CACHE_FILE" ]; then
		# PrÃ¼fe ob Cache Ã¤lter als 24 Stunden ist
		cache_age=$(($(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0)))
		if [ $cache_age -lt 86400 ]; then
			cat "$CACHE_FILE"
			return 0
		fi
	fi
	return 1
}

# Datenschutzfreundliche IP-Info Abfrage mit Cache-Speicherung
getipinfo() {
	notify-send "ğŸ” IP-Standort" "Aktualisiere Standort-Informationen..."

	# Methode 1: ifconfig.co (Open Source, minimal logging)
	response=$(curl -s --max-time 3 "https://ifconfig.co/json" 2>/dev/null)
	if [ -n "$response" ]; then
		ip=$(echo "$response" | grep -o '"ip":"[^"]*' | cut -d'"' -f4)
		country_code=$(echo "$response" | grep -o '"country_iso":"[^"]*' | cut -d'"' -f4)
		country_name=$(echo "$response" | grep -o '"country":"[^"]*' | cut -d'"' -f4)
		city=$(echo "$response" | grep -o '"city":"[^"]*' | cut -d'"' -f4)
		# Bei ifconfig.co: country ist LÃ¤ndername, city ist Stadt
		location_info="$country_name"
		[ -n "$city" ] && location_info="$city, $country_name"
	fi

	# Methode 2: Falls ifconfig.co nicht funktioniert, nutze ipinfo.io
	if [ -z "$ip" ]; then
		response=$(curl -s --max-time 3 "https://ipinfo.io/json" 2>/dev/null)
		if [ -n "$response" ]; then
			ip=$(echo "$response" | grep -o '"ip":"[^"]*' | cut -d'"' -f4)
			country_code=$(echo "$response" | grep -o '"country":"[^"]*' | cut -d'"' -f4)
			city=$(echo "$response" | grep -o '"city":"[^"]*' | cut -d'"' -f4)
			region=$(echo "$response" | grep -o '"region":"[^"]*' | cut -d'"' -f4)
			# Bei ipinfo.io mÃ¼ssen wir LÃ¤ndernamen separat ermitteln
			location_info="$city"
			[ -n "$region" ] && location_info="$city, $region"
		fi
	fi

	# Fallback auf einfache Abfrage
	if [ -z "$ip" ]; then
		ip=$(curl -s --max-time 3 https://ifconfig.me 2>/dev/null)
		country_code=$(curl -s --max-time 3 https://ifconfig.co/country 2>/dev/null | tr -d '[:space:]')
		location_info=""
	fi

	# Bereinige und gebe zurÃ¼ck
	[ -z "$country_code" ] && country_code="??"
	[ -z "$location_info" ] && location_info="Unbekannt"

	result="$ip|$country_code|$location_info"

	# Speichere in Cache mit Timestamp
	printf "%s|%s\n" "$(date +%s)" "$result" > "$CACHE_FILE"

	printf "%s" "$result"
}

case $BLOCK_BUTTON in
	1) # Linksklick - Aktualisiere und zeige Info
		vpn_iface=$(check_vpn)
		# Erzwinge neue Abfrage
		info=$(getipinfo)
		ip=$(echo "$info" | cut -d'|' -f1)
		code=$(echo "$info" | cut -d'|' -f2)
		name=$(echo "$info" | cut -d'|' -f3)

		if [ -n "$vpn_iface" ]; then
			notify-send "ğŸŒ VPN-Standort ($vpn_iface)" "IP: $ip\nStandort: $name\nLand: $code\n\nâœ… Aktualisiert: $(date '+%H:%M:%S')"
		else
			notify-send "ğŸŒ Direkter Standort" "âš ï¸ Kein VPN aktiv!\n\nIP: $ip\nStandort: $name\nLand: $code\n\nâœ… Aktualisiert: $(date '+%H:%M:%S')"
		fi
		# Aktualisiere Statusbar
		pkill -RTMIN+28 dwmblocks
		;;
	3) # Rechtsklick - Zeige gespeicherte Info (ohne Aktualisierung)
		vpn_iface=$(check_vpn)

		# Lade aus Cache oder zeige Hinweis
		if [ -f "$CACHE_FILE" ]; then
			cache_data=$(cat "$CACHE_FILE")
			timestamp=$(echo "$cache_data" | cut -d'|' -f1)
			info=$(echo "$cache_data" | cut -d'|' -f2-)

			# Berechne Cache-Alter
			cache_age=$(($(date +%s) - timestamp))
			if [ $cache_age -lt 60 ]; then
				age_text="vor $(($cache_age)) Sekunden"
			elif [ $cache_age -lt 3600 ]; then
				age_text="vor $(($cache_age / 60)) Minuten"
			elif [ $cache_age -lt 86400 ]; then
				age_text="vor $(($cache_age / 3600)) Stunden"
			else
				age_text="vor $(($cache_age / 86400)) Tagen"
			fi

			ip=$(echo "$info" | cut -d'|' -f1)
			code=$(echo "$info" | cut -d'|' -f2)
			name=$(echo "$info" | cut -d'|' -f3)

			if [ -n "$vpn_iface" ]; then
				# Bei WireGuard: ZusÃ¤tzliche Infos
				extra_info=""
				if [ "${vpn_iface#wg}" != "$vpn_iface" ]; then
					endpoint=$(wg show "$vpn_iface" endpoints 2>/dev/null | awk '{print $2}')
					[ -n "$endpoint" ] && extra_info="\nVPN-Server: $endpoint"
				fi

				notify-send "ğŸŒ VPN-Status (Cache)" "Interface: $vpn_iface\nIP: $ip\nStandort: $name\nLand: $code$extra_info\n\nğŸ“… Letzte Aktualisierung: $age_text\nğŸ’¡ Linksklick zum Aktualisieren"
			else
				notify-send "ğŸŒ Standort (Cache)" "âš ï¸ WARNUNG: Kein VPN aktiv!\n\nIP: $ip\nStandort: $name\nLand: $code\n\nğŸ“… Letzte Aktualisierung: $age_text\nğŸ’¡ Linksklick zum Aktualisieren"
			fi
		else
			notify-send "ğŸŒ IP-Standort" "Keine gespeicherten Daten vorhanden.\n\nğŸ’¡ Linksklick zum Aktualisieren"
		fi
		;;
	6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

# Statusleisten-Ausgabe (wird bei Signal 0 nur bei Klicks aufgerufen)
vpn_iface=$(check_vpn)
if [ -n "$vpn_iface" ]; then
	# VPN aktiv - zeige LÃ¤ndercode in eckigen Klammern
	printf "ó°¢­[%s]\\n" "$vpn_iface"
else
	# Kein VPN - zeige nur Globus-Symbol
	printf "î¬ \\n"
fi
