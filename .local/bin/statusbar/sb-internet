#!/bin/sh
## 2025-06-13 SARBS
# AnhÃ¤ngigkeiten: nmcli, nmtui, dunst, wireless_tools (iwgetid)

# Prozente in Statusbar anzeigen? (true/false)
SHOW_PERCENT=false

case $BLOCK_BUTTON in
    1) # Linksklick: Wifi ein/ausschalten
        wifi_status=$(nmcli radio wifi)
        if [ "$wifi_status" = "enabled" ]; then
            # Wifi ist an, ausschalten
            nmcli radio wifi off
            notify-send "ó°–ª Wifi" "Wifi wurde deaktiviert"
        else
            # Wifi ist aus, einschalten
            nmcli radio wifi on
            notify-send "ó°¤¥ Wifi" "Wifi wird aktiviert..."
        fi
        pkill -RTMIN+23 dwmblocks
        ;;
    2) # ó°³¾ Netzwerkmanager (mittelklick)
        "$TERMINAL" -e nmtui; pkill -RTMIN+23 dwmblocks ;;
    3) # Rechtsklick: Aktuelle Verbindungen anzeigen (WiFi + VPN)
        wifi_iface=$(ls /sys/class/net | grep "^w" | grep -v "^wg" | head -n 1)

        # WiFi Status
        if [ -n "$wifi_iface" ] && [ "$(cat /sys/class/net/$wifi_iface/operstate 2>/dev/null)" = 'up' ]; then
            # SSID Ã¼ber verschiedene Methoden holen
            # Methode 1: iwgetid (falls installiert)
            current_ssid=$(iwgetid -r 2>/dev/null)

            # Methode 2: nmcli mit deutscher/englischer Ausgabe
            if [ -z "$current_ssid" ]; then
                current_ssid=$(nmcli -t -f active,ssid dev wifi | grep -E '^(yes|ja):' | cut -d: -f2 | head -1)
            fi

            # Methode 3: nmcli connection show
            if [ -z "$current_ssid" ]; then
                current_ssid=$(nmcli -t -f name,type connection show --active | grep ':802-11-wireless$' | cut -d: -f1 | head -1)
            fi

            # Fallback falls immer noch leer
            [ -z "$current_ssid" ] && current_ssid="Unbekannt"

            signal_strength=$(awk '/^\s*w/ { print int($3 * 100 / 70) }' /proc/net/wireless)
            # SignalstÃ¤rke-Icon
            if [ "$signal_strength" -ge 76 ]; then
                signal_icon="ó°¤¥"
            elif [ "$signal_strength" -ge 51 ]; then
                signal_icon="ó°¤¢"
            elif [ "$signal_strength" -ge 26 ]; then
                signal_icon="ó°¤Ÿ"
            else
                signal_icon="ó°¤¯"
            fi
            wifi_info="$signal_icon WiFi: ${current_ssid} (${signal_strength}%)"
        else
            wifi_info="ó°¤« WiFi: Nicht verbunden"
        fi

        # VPN Status prÃ¼fen
        vpn_info=""
        for iface in /sys/class/net/*; do
            [ ! -e "$iface" ] && continue
            iface_name="${iface##*/}"

            case "$iface_name" in
                tun*|tap*|wg*|ppp*|vpn*)
                    if [ -e "$iface/operstate" ]; then
                        state=$(cat "$iface/operstate" 2>/dev/null)
                        if [ "$state" = "up" ] || [ "$state" = "unknown" ]; then
                            # FÃ¼r WireGuard: Versuche Endpoint zu bekommen
                            if [ "${iface_name#wg}" != "$iface_name" ]; then
                                endpoint=$(wg show "$iface_name" endpoints 2>/dev/null | awk '{print $2}' | cut -d: -f1)
                                [ -n "$endpoint" ] && vpn_info="ó°¢­ VPN: $iface_name (â†’ $endpoint)" || vpn_info="ó°¢­ VPN: $iface_name"
                            else
                                vpn_info="ó°¢­ VPN: $iface_name aktiv"
                            fi
                            break
                        fi
                    fi
                    ;;
            esac
        done
        [ -z "$vpn_info" ] && vpn_info="ó°¦ž VPN: Nicht verbunden"

        # Ethernet Status
        eth_iface=$(ls /sys/class/net | grep "^e" | head -n 1)
        if [ "$(cat /sys/class/net/$eth_iface/operstate 2>/dev/null)" = 'up' ]; then
            eth_info="ó°±” Ethernet: Verbunden"
        else
            eth_info="ó°²œ Ethernet: Nicht verbunden"
        fi

        notify-send "ó°³¾ Netzwerk Status" "$wifi_info
$vpn_info
$eth_info

ó°‰ Linksklick: WiFi ein/aus
ó°‰ Mittelklick: NetworkManager Ã¶ffnen"
        ;;
    4) ;;
    5) # Button 5: VerfÃ¼gbare Netzwerke scannen (nur bei Bedarf)
        notify-send "ðŸ” Scanne Netzwerke..." "Bitte warten..."

        # Hier der langsame Scan - nur wenn explizit gewÃ¼nscht
        available_networks=$(nmcli -t -f ssid,signal dev wifi | grep -v '^$' | sort -t: -k2 -nr | head -5 | while read line; do
            ssid=$(echo "$line" | cut -d: -f1 | cut -c1-20)
            signal=$(echo "$line" | cut -d: -f2)
            if [ "$signal" -ge 76 ]; then
                icon="ó°¤¥"
            elif [ "$signal" -ge 51 ]; then
                icon="ó°¤¢"
            elif [ "$signal" -ge 26 ]; then
                icon="ó°¤Ÿ"
            else
                icon="ó°¤¯"
            fi
            echo "$icon $ssid ($signal%)"
        done)

        notify-send "ðŸ“¡ VerfÃ¼gbare Netzwerke" "$available_networks"
        ;;
    6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

# Erkenne interfaces - schlieÃŸe WireGuard (wg*) aus
wifi_iface=$(ls /sys/class/net | grep "^w" | grep -v "^wg" | head -n 1)
eth_iface=$(ls /sys/class/net | grep "^e" | head -n 1)

# Wifi mit prozentabhÃ¤ngigen Symbolen
if [ -n "$wifi_iface" ]; then
    if [ "$(cat /sys/class/net/$wifi_iface/operstate 2>/dev/null)" = 'up' ] ; then
        signal_percent=$(awk '/^\s*w/ { print int($3 * 100 / 70) }' /proc/net/wireless)
        if [ "$signal_percent" -ge 76 ]; then
            wifiicon="ó°¤¥"
        elif [ "$signal_percent" -ge 51 ]; then
            wifiicon="ó°¤¢"
        elif [ "$signal_percent" -ge 26 ]; then
            wifiicon="ó°¤Ÿ"
        else
            wifiicon="ó°¤¯"
        fi
        # Optional: Prozente anhÃ¤ngen
        [ "$SHOW_PERCENT" = "true" ] && wifiicon="$wifiicon ${signal_percent}%"
    elif [ "$(cat /sys/class/net/$wifi_iface/operstate 2>/dev/null)" = 'down' ] ; then
        [ "$(cat /sys/class/net/$wifi_iface/flags 2>/dev/null)" = '0x1003' ] && wifiicon="ó°–ª" || wifiicon="ó°¤«"
    fi
else
    wifiicon="ó°¤«"
fi

# Ethernet
# ó°²œ kein Ethernet
# ó°±” Ethernet angeschlossen
[ "$(cat /sys/class/net/$eth_iface/operstate 2>/dev/null)" = 'up' ] && ethericon="ó°±”" || ethericon=""

# VPN Tunnel - prÃ¼fe verschiedene VPN-Interface-Typen
# ó°¢­ vpn is aktiv
vpn_active=""
for iface in /sys/class/net/*; do
    [ ! -e "$iface" ] && continue
    iface_name="${iface##*/}"

    # PrÃ¼fe auf VPN-Interface-Namen
    case "$iface_name" in
        tun*|tap*|wg*|ppp*|vpn*)
            # WireGuard zeigt "unknown" statt "up", prÃ¼fe ob Interface existiert
            if [ -e "$iface/operstate" ]; then
                state=$(cat "$iface/operstate" 2>/dev/null)
                # Bei WireGuard reicht "unknown", bei anderen brauchen wir "up"
                if [ "$state" = "up" ] || [ "$state" = "unknown" ]; then
                    vpn_active="yes"
                    break
                fi
            fi
            ;;
    esac
done
[ -n "$vpn_active" ] && tunicon="ó°¯…" # ó°¢­  ó°¥Ž  ó°¯„  ó°¯… ...

printf "%s%s%s\n" "$wifiicon " "$ethericon$tunicon"
