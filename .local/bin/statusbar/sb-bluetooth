#!/bin/sh
## 2025-04-01 SARBS

# Signalnummer für dwmblocks-Aktualisierung (muss mit config.h übereinstimmen)
SIG=18

# Symbole (Nerd Font) – bei Bedarf anpassen
ICON_ON="󰂱"
ICON_OFF="󰂲"

# bluetoothctl-Abfrage über stdin (direkte Argumente unzuverlässig)
btctl() { echo "$1" | bluetoothctl 2>/dev/null; }

bt_powered() { btctl "show" | grep -F -q "Powered: yes"; }

bt_toggle() {
	if bt_powered; then
		btctl "power off"
	else
		rfkill list bluetooth | grep -F -q 'blocked: yes' &&
			rfkill unblock bluetooth && sleep 0.5
		btctl "power on"
	fi
	pkill -RTMIN+$SIG dwmblocks 2>/dev/null
}

# Verbundene Geräte mit Batteriestand auflisten
bt_devices() {
	bt_powered || { echo "Bluetooth ist ausgeschaltet"; return; }

	paired=$(btctl "devices Paired" | grep -F Device | cut -d ' ' -f 2)
	[ -z "$paired" ] && { echo "Keine gekoppelten Geräte"; return; }

	found=0
	out="Verbundene Geräte:"
	for dev in $paired; do
		info=$(btctl "info $dev")
		echo "$info" | grep -F -q "Connected: yes" || continue
		found=1
		name=$(echo "$info" | grep -F "Alias" | cut -d ' ' -f 2-)
		bat=$(echo "$info" | grep -F "Battery Percentage:" | grep -o '([0-9]*)' | tr -d '()')
		out="${out}\n• ${name}${bat:+ ${bat}%}"
	done
	[ "$found" -eq 0 ] && out="${out}\nKeine verbundenen Geräte"
	printf '%b\n' "$out"
}

icon() { bt_powered && echo "$ICON_ON" || echo "$ICON_OFF"; }

case $BLOCK_BUTTON in
	1) setsid -f "$TERMINAL" -e bluetui
	   pkill -RTMIN+$SIG dwmblocks 2>/dev/null ;;
	2) bt_toggle ;;
	3) notify-send "$(icon) Bluetooth Modul" "\
$(bt_devices)

- L 󰍽 bluetui (Bluetooth-Manager).
- M 󰍽 Bluetooth Ein/Aus.
- R 󰍽 Diese Meldung anzeigen." ;;
	6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

icon
