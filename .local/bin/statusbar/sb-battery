#!/bin/sh
## 2025-11-21 SARBS

# Zeigt den aggregierten Batteriestand mit Symbolen entsprechend dem Ladestand an
# Inklusive automatischer Helligkeitsanpassung nach Tagesrhythmus

# ============================================================================
# KONFIGURATION - Tagesrhythmus für Helligkeit
# ============================================================================

# Zeitangaben in HH:MM Format
BRIGHTNESS_SUNRISE="06:00"       # Beginn der Aufhellphase
BRIGHTNESS_DAY_START="08:00"     # Volle Tageshelligkeit
BRIGHTNESS_SUNSET="19:00"        # Beginn der Abdunkelphase
BRIGHTNESS_NIGHT_START="21:00"   # Volle Nachthelligkeit

# Helligkeitswerte in Prozent
BRIGHTNESS_NIGHT=20             # Nachthelligkeit
BRIGHTNESS_DAY=100              # Tageshelligkeit
BRIGHTNESS_DEFAULT=80           # Standard beim Reset

# Manuelle Steuerung
BRIGHTNESS_MIN=5                # Minimale Helligkeit
BRIGHTNESS_MAX=100              # Maximale Helligkeit
BRIGHTNESS_STEP=5               # Schrittweite für manuell +/-

# ============================================================================
# SYSTEM - Cache-Verzeichnis nach XDG-Spezifikation
# ============================================================================

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/brightness"
AUTO_FILE="${CACHE_DIR}/auto_enabled"

# Erstelle Cache-Verzeichnis falls nicht vorhanden
mkdir -p "$CACHE_DIR"

# ============================================================================
# HELLIGKEITS-FUNKTIONEN
# ============================================================================

# Ermittle verfügbares Helligkeitstool
get_brightness_tool() {
    if command -v brightnessctl >/dev/null 2>&1; then
        echo "brightnessctl"
    elif command -v xbacklight >/dev/null 2>&1; then
        echo "xbacklight"
    else
        echo ""
    fi
}

# Aktuelle Helligkeit auslesen (0-100)
get_current_brightness() {
    tool=$(get_brightness_tool)
    case $tool in
        brightnessctl)
            brightnessctl -m | cut -d',' -f4 | tr -d '%'
            ;;
        xbacklight)
            xbacklight -get | cut -d'.' -f1
            ;;
        *)
            echo "50"
            ;;
    esac
}

# Helligkeit setzen (Prozent)
set_brightness() {
    local value=$1
    tool=$(get_brightness_tool)

    [ -z "$tool" ] && {
        notify-send " Kein Helligkeitstool gefunden"
        return 1
    }

    # Grenzen einhalten
    [ "$value" -lt "$BRIGHTNESS_MIN" ] && value=$BRIGHTNESS_MIN
    [ "$value" -gt "$BRIGHTNESS_MAX" ] && value=$BRIGHTNESS_MAX

    case $tool in
        brightnessctl)
            brightnessctl set "${value}%" >/dev/null
            ;;
        xbacklight)
            xbacklight -set "$value"
            ;;
    esac
}

# Konvertiere HH:MM zu Minuten seit Mitternacht
time_to_minutes() {
    echo "$1" | awk -F: '{print ($1 * 60) + $2}'
}

# Berechne automatische Helligkeit basierend auf Tageszeit
calculate_auto_brightness() {
    current_time=$(date +%H:%M)
    current_min=$(time_to_minutes "$current_time")

    sunrise_min=$(time_to_minutes "$BRIGHTNESS_SUNRISE")
    day_start_min=$(time_to_minutes "$BRIGHTNESS_DAY_START")
    sunset_min=$(time_to_minutes "$BRIGHTNESS_SUNSET")
    night_start_min=$(time_to_minutes "$BRIGHTNESS_NIGHT_START")

    if [ $current_min -ge $sunrise_min ] && [ $current_min -lt $day_start_min ]; then
        # Morgen-Phase: NIGHT -> DAY
        elapsed=$((current_min - sunrise_min))
        total=$((day_start_min - sunrise_min))
        diff=$((BRIGHTNESS_DAY - BRIGHTNESS_NIGHT))
        auto_brightness=$((BRIGHTNESS_NIGHT + (diff * elapsed / total)))

    elif [ $current_min -ge $day_start_min ] && [ $current_min -lt $sunset_min ]; then
        # Tag-Phase
        auto_brightness=$BRIGHTNESS_DAY

    elif [ $current_min -ge $sunset_min ] && [ $current_min -lt $night_start_min ]; then
        # Abend-Phase: DAY -> NIGHT
        elapsed=$((current_min - sunset_min))
        total=$((night_start_min - sunset_min))
        diff=$((BRIGHTNESS_DAY - BRIGHTNESS_NIGHT))
        auto_brightness=$((BRIGHTNESS_DAY - (diff * elapsed / total)))

    else
        # Nacht-Phase
        auto_brightness=$BRIGHTNESS_NIGHT
    fi

    echo "$auto_brightness"
}

# Toggle Auto-Modus
toggle_auto_brightness() {
    if [ -f "$AUTO_FILE" ]; then
        # Auto-Modus deaktivieren
        rm -f "$AUTO_FILE"
        current=$(get_current_brightness)
        notify-send " Auto-Helligkeit AUS" "Helligkeit: ${current}%"
    else
        # Auto-Modus aktivieren
        touch "$AUTO_FILE"
        new_brightness=$(calculate_auto_brightness)
        set_brightness "$new_brightness"
        notify-send " Auto-Helligkeit AN" "Helligkeit: ${new_brightness}%"
    fi
}

# Manuelle Helligkeits-Anpassung (deaktiviert Auto-Modus)
adjust_brightness() {
    local direction=$1

    # Deaktiviere Auto-Modus wenn aktiv
    [ -f "$AUTO_FILE" ] && rm -f "$AUTO_FILE"

    current=$(get_current_brightness)

    case $direction in
        inc)
            new_brightness=$((current + BRIGHTNESS_STEP))
            ;;
        dec)
            new_brightness=$((current - BRIGHTNESS_STEP))
            ;;
        *)
            return
            ;;
    esac

    set_brightness "$new_brightness"
}

# Reset: Deaktiviere Auto und setze auf Standard-Helligkeit
reset_brightness() {
    rm -f "$AUTO_FILE"
    set_brightness "$BRIGHTNESS_DEFAULT"
    notify-send " Helligkeit Reset" "${BRIGHTNESS_DEFAULT}%"
}

# Wende Auto-Helligkeit an (wird bei jedem Statusbar-Update aufgerufen)
apply_auto_brightness() {
    [ -f "$AUTO_FILE" ] || return

    new_brightness=$(calculate_auto_brightness)
    current=$(get_current_brightness)

    # Nur anwenden wenn Unterschied > 2% (verhindert unnötige Updates)
    diff=$((new_brightness - current))
    [ $diff -lt 0 ] && diff=$((diff * -1))

    [ $diff -gt 2 ] && set_brightness "$new_brightness"
}

# Sammelt Informationen über alle Batterien
get_all_batteries_info() {
    battery_info=""
    for battery in /sys/class/power_supply/BAT?*; do
        [ -d "$battery" ] || continue
        battery_name=$(basename "$battery")
        capacity=$(cat "$battery/capacity" 2>/dev/null)
        battery_info="${battery_info}${battery_name}: ${capacity}%\n"
    done
    echo "$battery_info"
}

get_battery_symbol() {
    capacity=$1
    if [ "$capacity" -le 10 ]; then
        echo "󰂃"
    elif [ "$capacity" -le 20 ]; then
        echo "󰁺"
    elif [ "$capacity" -le 30 ]; then
        echo "󰁻"
    elif [ "$capacity" -le 40 ]; then
        echo "󰁼"
    elif [ "$capacity" -le 50 ]; then
        echo "󰁽"
    elif [ "$capacity" -le 60 ]; then
        echo "󰁾"
    elif [ "$capacity" -le 70 ]; then
        echo "󰁿"
    elif [ "$capacity" -le 80 ]; then
        echo "󰂀"
    elif [ "$capacity" -le 90 ]; then
        echo "󰂁"
    else
        echo "󰁹"
    fi
}

get_battery_symbol_charger() {
    capacity=$1
    if [ "$capacity" -le 10 ]; then
        echo "󰢜"
    elif [ "$capacity" -le 20 ]; then
        echo "󰂆"
    elif [ "$capacity" -le 30 ]; then
        echo "󰂇"
    elif [ "$capacity" -le 40 ]; then
        echo "󰂈"
    elif [ "$capacity" -le 50 ]; then
        echo "󰢝"
    elif [ "$capacity" -le 60 ]; then
        echo "󰂉"
    elif [ "$capacity" -le 70 ]; then
        echo "󰢞"
    elif [ "$capacity" -le 80 ]; then
        echo "󰂊"
    elif [ "$capacity" -le 90 ]; then
        echo "󰂋"
    else
        echo "󰂅"
    fi
}

get_connection_status() {
    for ac in /sys/class/power_supply/AC* /sys/class/power_supply/Mains; do
        [ -e "$ac/online" ] || continue
        [ "$(cat "$ac/online")" -eq 1 ] && { echo "AC"; return; }
    done
    echo "BAT"
}

case $BLOCK_BUTTON in
    1) toggle_auto_brightness; pkill -RTMIN+22 dwmblocks ;;
    2) reset_brightness; pkill -RTMIN+22 dwmblocks ;;
    3)
        all_batteries=$(get_all_batteries_info)
        current_brightness=$(get_current_brightness)

        # Auto-Status ermitteln
        if [ -f "$AUTO_FILE" ]; then
            auto_status="AN (Automatisch)"
            current_time=$(date +%H:%M)
            current_min=$(time_to_minutes "$current_time")
            day_start_min=$(time_to_minutes "$BRIGHTNESS_DAY_START")
            sunset_min=$(time_to_minutes "$BRIGHTNESS_SUNSET")
            night_start_min=$(time_to_minutes "$BRIGHTNESS_NIGHT_START")
            sunrise_min=$(time_to_minutes "$BRIGHTNESS_SUNRISE")

            if [ $current_min -lt $sunrise_min ]; then
                next_change="Aufhellung um $BRIGHTNESS_SUNRISE"
            elif [ $current_min -lt $day_start_min ]; then
                next_change="Volle Helligkeit um $BRIGHTNESS_DAY_START"
            elif [ $current_min -lt $sunset_min ]; then
                next_change="Abdunkeln um $BRIGHTNESS_SUNSET"
            elif [ $current_min -lt $night_start_min ]; then
                next_change="Nachtmodus um $BRIGHTNESS_NIGHT_START"
            else
                next_change="Aufhellung um $BRIGHTNESS_SUNRISE (morgen)"
            fi
        else
            auto_status="AUS (Manuell)"
            next_change="Keine"
        fi

        notify-send "Batteriemodul" "\
Batteriestand:
${all_batteries}
Helligkeit: ${current_brightness}%
Auto-Modus: ${auto_status}
Nächste Änderung: ${next_change}

Konfiguration:
Tag (${BRIGHTNESS_DAY_START}-${BRIGHTNESS_SUNSET}): ${BRIGHTNESS_DAY}%
Nacht (${BRIGHTNESS_NIGHT_START}-${BRIGHTNESS_SUNRISE}): ${BRIGHTNESS_NIGHT}%

󱕒 Steuerung:
L-󰍽 Auto-Helligkeit ein/aus
M-󰍽 Zurücksetzen (${BRIGHTNESS_DEFAULT}%)
R-󰍽 Diese Infobox
󰍽 Helligkeit ±${BRIGHTNESS_STEP}% (deaktiviert Auto)" ;;
    4) adjust_brightness inc; pkill -RTMIN+22 dwmblocks ;;
    5) adjust_brightness dec; pkill -RTMIN+22 dwmblocks ;;
    6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

# Aggregiere alle Batterien
total_capacity=0
battery_count=0
for battery in /sys/class/power_supply/BAT?*; do
    [ -d "$battery" ] || continue
    capacity=$(cat "$battery/capacity" 2>/dev/null)
    total_capacity=$((total_capacity + capacity))
    battery_count=$((battery_count + 1))
done

[ "$battery_count" -gt 0 ] && overall_capacity=$((total_capacity / battery_count)) || overall_capacity=0

# Wähle das entsprechende Symbol basierend auf dem AC-/BAT-Status
if [ "$(get_connection_status)" = "AC" ]; then
    symbol=$(get_battery_symbol_charger "$overall_capacity")
else
    symbol=$(get_battery_symbol "$overall_capacity")
fi

# Wende Auto-Helligkeit an (bei jedem Statusbar-Update)
apply_auto_brightness

# Warnsymbol und kritische Benachrichtigung, wenn Akkuladung <= 10%
if [ "$overall_capacity" -le 3 ]; then
    warn=" "
    notify-send -u critical "Kritischer Batterieladung" "Akkuladung bei ${overall_capacity}%!"
else
    warn=""
fi

# Auto-Brightness-Symbol (Zusatz zum Batterie-Icon)
if [ -f "$AUTO_FILE" ]; then
    auto_symbol="󰖨"  # 󰖨 Auto-Modus
else
    auto_symbol=""  #  Manueller Modus
fi

# output="$symbol$warn$overall_capacity%"
output="$auto_symbol$symbol$warn"
echo "$output"
